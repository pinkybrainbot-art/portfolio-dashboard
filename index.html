<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Portfolio Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
    }
    
    /* Login Screen */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-box {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 360px;
      text-align: center;
    }
    .login-box h1 { color: #58a6ff; margin-bottom: 10px; font-size: 1.5rem; }
    .login-box p { color: #8b949e; margin-bottom: 25px; font-size: 0.9rem; }
    .pin-input {
      width: 100%;
      padding: 15px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #c9d1d9;
      font-size: 1.5rem;
      text-align: center;
      letter-spacing: 8px;
      margin-bottom: 15px;
    }
    .pin-input:focus { outline: none; border-color: #58a6ff; }
    .login-error { color: #f85149; font-size: 0.85rem; margin-bottom: 15px; display: none; }
    .login-btn {
      width: 100%;
      padding: 12px;
      background: #238636;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    .login-btn:hover { background: #2ea043; }
    .app-content { display: none; }
    
    /* Navigation */
    .nav {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
      flex-wrap: wrap;
      gap: 10px;
    }
    .nav h1 { color: #58a6ff; font-size: 1.3rem; }
    .nav-tabs { display: flex; gap: 5px; flex-wrap: wrap; }
    .nav-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: #8b949e;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .nav-tab:hover { color: #c9d1d9; background: #21262d; }
    .nav-tab.active { color: #58a6ff; background: #21262d; }
    
    .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Cards */
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .card-title { font-size: 1rem; color: #c9d1d9; }
    
    /* Grid Layouts */
    .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    
    /* Stat Cards */
    .stat-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
    }
    .stat-value { font-size: 1.8rem; font-weight: 700; color: #58a6ff; margin-bottom: 5px; }
    .stat-label { font-size: 0.85rem; color: #8b949e; }
    
    /* Tables */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #21262d; }
    th { color: #8b949e; font-weight: 500; font-size: 0.85rem; }
    td { font-size: 0.9rem; }
    tr:hover { background: #21262d; }
    .ticker { font-weight: 600; color: #58a6ff; }
    .positive { color: #3fb950; }
    .negative { color: #f85149; }
    
    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .btn-primary { background: #238636; color: white; }
    .btn-primary:hover { background: #2ea043; }
    .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
    .btn-secondary:hover { background: #30363d; }
    .btn-ask {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn-ask:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-ask:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    
    /* Summary Bar */
    .summary-bar {
      display: flex;
      gap: 20px;
      padding: 15px 20px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }
    .summary-item { display: flex; gap: 8px; align-items: center; }
    .summary-label { color: #8b949e; }
    .summary-value { font-weight: 600; }
    
    /* Holdings list */
    .holding-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #21262d;
    }
    .holding-item:last-child { border-bottom: none; }
    .holding-ticker { font-weight: 600; color: #58a6ff; }
    .holding-name { font-size: 0.8rem; color: #8b949e; }
    .holding-value { text-align: right; }
    .holding-shares { font-size: 0.8rem; color: #8b949e; }
    
    /* Notes */
    .note-card {
      background: #21262d;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .note-meta { font-size: 0.75rem; color: #8b949e; margin-bottom: 8px; display: flex; gap: 10px; }
    .note-author { color: #58a6ff; font-weight: 500; }
    .note-text { font-size: 0.9rem; line-height: 1.5; }
    .note-tags { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
    .tag { background: #30363d; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; color: #8b949e; }
    
    /* Macro indicators */
    .macro-card {
      background: #21262d;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .macro-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
    .macro-name { font-size: 0.85rem; color: #8b949e; }
    .macro-trend { font-size: 0.75rem; margin-top: 5px; }
    .trend-up { color: #3fb950; }
    .trend-down { color: #f85149; }
    .trend-neutral { color: #8b949e; }
    
    /* Watchlist */
    .watchlist-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #21262d;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .watchlist-ticker { font-weight: 600; color: #58a6ff; }
    .watchlist-note { font-size: 0.8rem; color: #8b949e; }
    
    /* Theses */
    .thesis-card {
      background: #21262d;
      border-radius: 8px;
      padding: 15px;
    }
    .thesis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .thesis-ticker { font-weight: 600; color: #58a6ff; font-size: 1.1rem; }
    .thesis-conviction {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      text-transform: uppercase;
    }
    .conviction-high { background: #238636; color: white; }
    .conviction-medium { background: #9e6a03; color: white; }
    .conviction-low { background: #6e7681; color: white; }
    .thesis-text { font-size: 0.9rem; line-height: 1.5; color: #c9d1d9; }
    
    /* Ask Pinky Section */
    .ask-pinky-section {
      background: linear-gradient(135deg, #1a1f35 0%, #161b22 100%);
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      margin-bottom: 20px;
    }
    .ask-pinky-title { font-size: 1.2rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .ask-pinky-desc { color: #8b949e; font-size: 0.9rem; margin-bottom: 20px; }
    .ask-response {
      background: #0d1117;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: left;
      display: none;
    }
    .ask-response.active { display: block; }
    .ask-response-text { white-space: pre-wrap; line-height: 1.6; }
    
    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 { margin-bottom: 20px; font-size: 1.2rem; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #8b949e; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 0.9rem;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #58a6ff;
    }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    
    /* Config notice */
    .config-notice {
      background: #9e6a03;
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 0.9rem;
    }
    .config-notice a { color: white; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; color: #8b949e; }
    .spinner {
      border: 3px solid #30363d;
      border-top: 3px solid #58a6ff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Responsive */
    @media (max-width: 768px) {
      .nav { flex-direction: column; align-items: flex-start; }
      .stat-value { font-size: 1.4rem; }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Config Notice (shown when Supabase not configured) -->
  <div class="config-notice" id="configNotice" style="display:none;">
    ‚ö†Ô∏è Supabase not configured. Using local data. <a href="#" onclick="showConfigModal()">Configure now</a>
  </div>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>üîê Portfolio Dashboard</h1>
      <p>Enter your PIN to access</p>
      <input type="password" class="pin-input" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" autofocus>
      <div class="login-error" id="loginError">Incorrect PIN</div>
      <button class="login-btn" onclick="checkPin()">Unlock</button>
    </div>
  </div>
  
  <!-- App Content -->
  <div class="app-content" id="appContent">
    <nav class="nav">
      <h1>üìä Portfolio Dashboard</h1>
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="overview">Overview</button>
        <button class="nav-tab" data-tab="holdings">Holdings</button>
        <button class="nav-tab" data-tab="theses">Theses</button>
        <button class="nav-tab" data-tab="transactions">Log</button>
        <button class="nav-tab" data-tab="watchlist">Watchlist</button>
        <button class="nav-tab" data-tab="macro">Macro</button>
        <button class="nav-tab" data-tab="notes">Notes</button>
      </div>
    </nav>
    
    <div class="summary-bar">
      <div class="summary-item">
        <span class="summary-label">Total Value:</span>
        <span class="summary-value" id="totalValue">$0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Cash:</span>
        <span class="summary-value" id="cashValue">$0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Positions:</span>
        <span class="summary-value" id="positionCount">0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Last Updated:</span>
        <span class="summary-value" id="lastUpdated">-</span>
      </div>
    </div>
    
    <div class="container">
      <!-- Overview Tab -->
      <div class="tab-content active" id="overview">
        <div class="grid-4" style="margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-value" id="statStocks">$0</div>
            <div class="stat-label">Stocks</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCrypto">$0</div>
            <div class="stat-label">Crypto</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCash">$0</div>
            <div class="stat-label">Cash</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAllocation">0%</div>
            <div class="stat-label">Invested</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìà Portfolio Value (Weekly)</span>
          </div>
          <canvas id="valueChart" height="100"></canvas>
        </div>
        
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <span class="card-title">üíº Top Holdings</span>
            </div>
            <div id="topHoldings"></div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <span class="card-title">üß† Pinky's Thoughts</span>
              <button class="btn btn-ask" onclick="askPinky('quick')" id="askQuickBtn">
                üîÆ Quick Analysis
              </button>
            </div>
            <div id="pinkyNotes"></div>
            <div class="ask-response" id="quickResponse">
              <div class="ask-response-text" id="quickResponseText"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Holdings Tab -->
      <div class="tab-content" id="holdings">
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìä All Holdings</span>
            <button class="btn btn-primary" onclick="openModal('holdingModal')">+ Add</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Name</th>
                  <th>Shares</th>
                  <th>Price</th>
                  <th>Value</th>
                  <th>Type</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="holdingsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Theses Tab -->
      <div class="tab-content" id="theses">
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìù Investment Theses</span>
            <button class="btn btn-primary" onclick="openModal('thesisModal')">+ Add</button>
          </div>
          <div class="grid-2" id="thesesGrid"></div>
        </div>
      </div>
      
      <!-- Transactions Tab -->
      <div class="tab-content" id="transactions">
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìú Transaction Log</span>
            <button class="btn btn-primary" onclick="openModal('transactionModal')">+ Add</button>
          </div>
          <div id="transactionLog"></div>
        </div>
      </div>
      
      <!-- Watchlist Tab -->
      <div class="tab-content" id="watchlist">
        <div class="card">
          <div class="card-header">
            <span class="card-title">üëÄ Watchlist</span>
            <button class="btn btn-primary" onclick="openModal('watchlistModal')">+ Add</button>
          </div>
          <div id="watchlistItems"></div>
        </div>
      </div>
      
      <!-- Macro Tab -->
      <div class="tab-content" id="macro">
        <div class="ask-pinky-section">
          <div class="ask-pinky-title">üß† Ask Pinky for Macro Analysis</div>
          <p class="ask-pinky-desc">Get an AI-powered analysis of current market conditions, liquidation levels, and how they might affect your portfolio.</p>
          <button class="btn btn-ask" onclick="askPinky('macro')" id="askMacroBtn">
            üîÆ Analyze Market & Portfolio
          </button>
          <div class="ask-response" id="macroResponse">
            <div class="ask-response-text" id="macroResponseText"></div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">üåç Market Indicators</span>
          </div>
          <div class="grid-4" id="macroGrid"></div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <span class="card-title">üìä Quick Links</span>
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="https://www.coinglass.com/LiquidationData" target="_blank" class="btn btn-secondary">üìâ BTC Liquidations</a>
            <a href="https://edition.cnn.com/markets/fear-and-greed" target="_blank" class="btn btn-secondary">üò± Fear & Greed</a>
            <a href="https://fred.stlouisfed.org/series/M2SL" target="_blank" class="btn btn-secondary">üíµ M2 Money Supply</a>
            <a href="https://www.tradingview.com/symbols/TVC-DXY/" target="_blank" class="btn btn-secondary">üí≤ DXY Index</a>
            <a href="https://www.tradingview.com/symbols/TVC-VIX/" target="_blank" class="btn btn-secondary">üìä VIX</a>
          </div>
        </div>
      </div>
      
      <!-- Notes Tab -->
      <div class="tab-content" id="notes">
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìù Notes</span>
            <button class="btn btn-primary" onclick="openModal('noteModal')">+ Add</button>
          </div>
          <div id="notesList"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modals -->
  <div class="modal-overlay" id="holdingModal">
    <div class="modal">
      <h2>Add/Edit Holding</h2>
      <div class="form-group">
        <label>Symbol</label>
        <input type="text" id="holdingSymbol" placeholder="TSLA">
      </div>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="holdingName" placeholder="Tesla Inc">
      </div>
      <div class="form-group">
        <label>Shares</label>
        <input type="number" step="0.00000001" id="holdingShares" placeholder="100">
      </div>
      <div class="form-group">
        <label>Current Price</label>
        <input type="number" step="0.01" id="holdingPrice" placeholder="250.00">
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="holdingType">
          <option value="stock">Stock</option>
          <option value="crypto">Crypto</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('holdingModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveHolding()">Save</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="noteModal">
    <div class="modal">
      <h2>Add Note</h2>
      <div class="form-group">
        <label>Author</label>
        <select id="noteAuthor">
          <option value="chris">Chris</option>
          <option value="pinky">Pinky</option>
        </select>
      </div>
      <div class="form-group">
        <label>Note</label>
        <textarea id="noteText" rows="4" placeholder="Your thoughts..."></textarea>
      </div>
      <div class="form-group">
        <label>Tags (comma separated)</label>
        <input type="text" id="noteTags" placeholder="strategy, crypto">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('noteModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveNote()">Save</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="transactionModal">
    <div class="modal">
      <h2>Add Transaction</h2>
      <div class="form-group">
        <label>Symbol</label>
        <input type="text" id="txSymbol" placeholder="TSLA">
      </div>
      <div class="form-group">
        <label>Action</label>
        <select id="txAction">
          <option value="buy">Buy</option>
          <option value="sell">Sell</option>
        </select>
      </div>
      <div class="form-group">
        <label>Shares</label>
        <input type="number" step="0.00000001" id="txShares" placeholder="10">
      </div>
      <div class="form-group">
        <label>Price</label>
        <input type="number" step="0.01" id="txPrice" placeholder="250.00">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="txDate">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTransaction()">Save</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="watchlistModal">
    <div class="modal">
      <h2>Add to Watchlist</h2>
      <div class="form-group">
        <label>Symbol</label>
        <input type="text" id="watchSymbol" placeholder="AAPL">
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="watchNotes" rows="3" placeholder="Why watching..."></textarea>
      </div>
      <div class="form-group">
        <label>Target Entry Price</label>
        <input type="number" step="0.01" id="watchTarget" placeholder="150.00">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('watchlistModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveWatchlist()">Save</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="thesisModal">
    <div class="modal">
      <h2>Add Investment Thesis</h2>
      <div class="form-group">
        <label>Symbol</label>
        <input type="text" id="thesisSymbol" placeholder="TSLA">
      </div>
      <div class="form-group">
        <label>Thesis</label>
        <textarea id="thesisText" rows="4" placeholder="Your investment thesis..."></textarea>
      </div>
      <div class="form-group">
        <label>Conviction</label>
        <select id="thesisConviction">
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
      <div class="form-group">
        <label>Target Price</label>
        <input type="number" step="0.01" id="thesisTarget" placeholder="500.00">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('thesisModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveThesis()">Save</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="configModal">
    <div class="modal">
      <h2>‚öôÔ∏è Supabase Configuration</h2>
      <p style="color: #8b949e; margin-bottom: 20px; font-size: 0.9rem;">
        Connect to Supabase for persistent storage. Get your credentials from your Supabase project settings.
      </p>
      <div class="form-group">
        <label>Supabase URL</label>
        <input type="text" id="configUrl" placeholder="https://xxxxx.supabase.co">
      </div>
      <div class="form-group">
        <label>Anon Key</label>
        <input type="text" id="configKey" placeholder="eyJhbGci...">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('configModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveConfig()">Connect</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIG ====================
    const PIN_HASH = '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92'; // SHA256 of '123456'
    const SESSION_KEY = 'portfolio-auth-v2';
    const TELEGRAM_BOT_USERNAME = 'PinkyPablo_bot';
    
    // Supabase config (pre-configured, can override via localStorage)
    let supabaseUrl = localStorage.getItem('supabase_url') || 'https://wfifrubydsyyrspneqst.supabase.co';
    let supabaseKey = localStorage.getItem('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaWZydWJ5ZHN5eXJzcG5lcXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTUxNTQsImV4cCI6MjA4NTYzMTE1NH0.SbniMd6HizrdeZIRT77iguGDoJeo2MThEEXcXDm13UY';
    let supabaseClient = null;
    
    // ==================== DEFAULT DATA ====================
    const DEFAULT_DATA = {
      holdings: [
        { symbol: 'TSLA', name: 'Tesla', shares: 215.31, price: 418, type: 'stock' },
        { symbol: 'CARR', name: 'Carrier Global', shares: 193.24, price: 68.94, type: 'stock' },
        { symbol: 'ANET', name: 'Arista Networks', shares: 77.07, price: 115.60, type: 'stock' },
        { symbol: 'NVDA', name: 'NVIDIA', shares: 38.57, price: 116.66, type: 'stock' },
        { symbol: 'FTNT', name: 'Fortinet', shares: 84.44, price: 103.74, type: 'stock' },
        { symbol: 'MRVL', name: 'Marvell Technology', shares: 83.81, price: 106.78, type: 'stock' },
        { symbol: 'SNOW', name: 'Snowflake', shares: 48.14, price: 186.26, type: 'stock' },
        { symbol: 'HIMS', name: 'Hims & Hers Health', shares: 545.40, price: 54.37, type: 'stock' },
        { symbol: 'MSTR', name: 'MicroStrategy', shares: 153.45, price: 338.78, type: 'stock' },
        { symbol: 'BTC', name: 'Bitcoin', shares: 1, price: 97762, type: 'crypto' },
        { symbol: 'SOL', name: 'Solana', shares: 121, price: 189.34, type: 'crypto' },
      ],
      cash: 32460,
      weeklyValues: [
        { date: '2026-01-06', value: 295000 },
        { date: '2026-01-13', value: 302000 },
        { date: '2026-01-20', value: 298000 },
        { date: '2026-01-27', value: 314000 },
        { date: '2026-02-02', value: 311260 },
      ],
      theses: [
        { symbol: 'TSLA', thesis: 'Robotaxi and humanoid robots not priced in. Full autonomy could 10x revenue. Optimus humanoid is massive TAM.', conviction: 'high', target: 1000 },
        { symbol: 'NVDA', thesis: 'AI infrastructure backbone. Every major company needs their chips. Moat is deep.', conviction: 'high', target: 200 },
        { symbol: 'HIMS', thesis: 'DTC healthcare disruption. Growing revenue 50%+ YoY. GLP-1s are huge catalyst.', conviction: 'medium', target: 80 },
      ],
      watchlist: [
        { symbol: 'CRWV', notes: 'AI infrastructure play. High risk/reward. Watch for entry.', target: 35 },
        { symbol: 'RKLB', notes: 'Space optionality. Rocket Lab has real customers.', target: 20 },
        { symbol: 'MU', notes: 'Best value in semis. Memory cycle turning.', target: 90 },
      ],
      transactions: [
        { symbol: 'TSLA', action: 'buy', shares: 30, price: 418, date: '2026-02-02', notes: 'Good entry on dip' },
        { symbol: 'SUI', action: 'sell', shares: 2500, price: 4.20, date: '2026-01-30', notes: 'Taking profits, crypto bearish' },
        { symbol: 'IONQ', action: 'sell', shares: 150, price: 42.50, date: '2026-01-28', notes: 'Quantum hype overblown' },
        { symbol: 'LMT', action: 'sell', shares: 45, price: 485.00, date: '2026-01-25', notes: 'Taking profits' },
      ],
      notes: [
        { date: '2026-02-02', author: 'pinky', text: 'Portfolio repositioning complete. Sold speculative positions and holding $45k cash for high-conviction entries.', tags: ['strategy'] },
        { date: '2026-02-02', author: 'pinky', text: 'Crypto in bear mode ‚Äî BTC dominance rising. Keeping core BTC + SOL positions. Patience over FOMO.', tags: ['crypto', 'macro'] },
        { date: '2026-02-01', author: 'chris', text: 'Want long term holds that can realistically 3X. Looking for undervalued plays.', tags: ['strategy'] },
      ],
      macroIndicators: [
        { id: 'vix', name: 'VIX', value: '18.2', trend: 'up' },
        { id: 'dxy', name: 'DXY', value: '108.4', trend: 'up' },
        { id: 'btc-dom', name: 'BTC Dominance', value: '58.2%', trend: 'up' },
        { id: '10y', name: '10Y Treasury', value: '4.52%', trend: 'up' },
        { id: 'fear-greed', name: 'Fear & Greed', value: '44', trend: 'down' },
        { id: 'm2', name: 'M2 YoY', value: '+3.2%', trend: 'up' },
        { id: 'spx', name: 'S&P 500', value: '6,040', trend: 'neutral' },
        { id: 'btc-liq', name: 'BTC Liq Levels', value: '$92k / $104k', trend: 'neutral' },
      ],
      lastUpdated: new Date().toISOString()
    };
    
    let data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    
    // ==================== AUTH ====================
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    async function checkPin() {
      const pin = document.getElementById('pinInput').value;
      const hash = await sha256(pin);
      if (hash === PIN_HASH) {
        sessionStorage.setItem(SESSION_KEY, 'true');
        showApp();
      } else {
        document.getElementById('loginError').style.display = 'block';
        document.getElementById('pinInput').value = '';
        document.getElementById('pinInput').focus();
      }
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
      initSupabase();
      loadData();
    }
    
    document.getElementById('pinInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') checkPin();
    });
    
    // ==================== SUPABASE ====================
    function initSupabase() {
      console.log('Initializing Supabase...', { url: supabaseUrl, hasKey: !!supabaseKey });
      if (supabaseUrl && supabaseKey && window.supabase) {
        try {
          supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
          document.getElementById('configNotice').style.display = 'none';
          console.log('Supabase client created successfully');
        } catch (e) {
          console.error('Supabase init failed:', e);
          supabaseClient = null;
          document.getElementById('configNotice').style.display = 'block';
        }
      } else {
        console.log('Supabase not available:', { hasUrl: !!supabaseUrl, hasKey: !!supabaseKey, hasLib: !!window.supabase });
        document.getElementById('configNotice').style.display = 'block';
      }
    }
    
    async function loadData() {
      console.log('loadData() called, supabase client:', !!supabaseClient);
      console.log('Current data.holdings.length:', data.holdings?.length);
      
      let loadedFromSupabase = false;
      
      if (supabaseClient) {
        try {
          console.log('Fetching from Supabase...');
          
          // Fetch all data
          const [holdingsRes, pricesRes, settingsRes, snapshotsRes, thesesRes, watchlistRes, transactionsRes, notesRes, macroRes] = await Promise.all([
            supabaseClient.from('holdings').select('*'),
            supabaseClient.from('prices').select('*'),
            supabaseClient.from('settings').select('*'),
            supabaseClient.from('snapshots').select('*').order('date', { ascending: true }),
            supabaseClient.from('theses').select('*'),
            supabaseClient.from('watchlist').select('*'),
            supabaseClient.from('transactions').select('*').order('date', { ascending: false }),
            supabaseClient.from('notes').select('*').order('created_at', { ascending: false }),
            supabaseClient.from('macro_indicators').select('*'),
          ]);
          
          console.log('Supabase responses:', { 
            holdings: holdingsRes.data?.length, 
            prices: pricesRes.data?.length,
            holdingsError: holdingsRes.error,
            pricesError: pricesRes.error
          });
          
          // Only proceed if we got holdings
          if (holdingsRes.data && holdingsRes.data.length > 0) {
            loadedFromSupabase = true;
            
            // Build price map
            const priceMap = {};
            if (pricesRes.data) {
              pricesRes.data.forEach(p => { priceMap[p.symbol] = parseFloat(p.price); });
            }
            
            // Update data object
            data.holdings = holdingsRes.data.map(h => ({
              symbol: h.symbol,
              name: h.name,
              shares: parseFloat(h.shares),
              price: priceMap[h.symbol] || 0,
              type: h.type
            }));
            
            if (settingsRes.data?.length) {
              const cashSetting = settingsRes.data.find(s => s.key === 'cash');
              if (cashSetting) data.cash = parseFloat(cashSetting.value);
            }
            
            if (snapshotsRes.data?.length) {
              data.weeklyValues = snapshotsRes.data.map(s => ({ date: s.date, value: parseFloat(s.total_value) }));
            }
            
            if (thesesRes.data?.length) {
              data.theses = thesesRes.data.map(t => ({ symbol: t.symbol, thesis: t.thesis, conviction: t.conviction, target: t.target_price }));
            }
            
            if (watchlistRes.data?.length) {
              data.watchlist = watchlistRes.data.map(w => ({ symbol: w.symbol, notes: w.notes, target: w.target_entry }));
            }
            
            if (transactionsRes.data?.length) {
              data.transactions = transactionsRes.data.map(t => ({ symbol: t.symbol, action: t.action, shares: parseFloat(t.shares), price: parseFloat(t.price), date: t.date, notes: t.notes }));
            }
            
            if (notesRes.data?.length) {
              data.notes = notesRes.data.map(n => ({ date: n.created_at.split('T')[0], author: n.author, text: n.content, tags: n.tags || [] }));
            }
            
            if (macroRes.data?.length) {
              data.macroIndicators = macroRes.data.map(m => ({ id: m.id, name: m.name, value: m.value, trend: m.trend }));
            }
            
            data.lastUpdated = new Date().toISOString();
            console.log('‚úÖ Data loaded from Supabase:', data.holdings.length, 'holdings');
          } else {
            console.log('‚ö†Ô∏è Supabase returned empty holdings, using defaults');
          }
        } catch (e) {
          console.error('‚ùå Supabase error:', e);
        }
      } else {
        console.log('‚ö†Ô∏è No Supabase client available');
      }
      
      // Ensure we have valid data - reset to defaults if something is wrong
      if (!data.holdings || data.holdings.length === 0) {
        console.log('üîÑ Resetting to DEFAULT_DATA');
        data = JSON.parse(JSON.stringify(DEFAULT_DATA));
      }
      
      console.log('üìä Final data state:', { 
        holdings: data.holdings?.length,
        cash: data.cash,
        source: loadedFromSupabase ? 'Supabase' : 'Defaults'
      });
      
      // Render
      try {
        initChart();
        render();
        console.log('‚úÖ Render complete');
      } catch (e) {
        console.error('‚ùå Render error:', e);
        // Last resort - show something
        alert('Error loading dashboard. Check console for details.');
      }
    }
    
    function saveLocal() {
      data.lastUpdated = new Date().toISOString();
      localStorage.setItem('portfolio-dashboard-v3', JSON.stringify(data));
    }
    
    // ==================== HELPERS ====================
    function formatCurrency(n) {
      return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    }
    
    function calculateTotals() {
      const stocksValue = data.holdings.filter(h => h.type === 'stock').reduce((sum, h) => sum + h.shares * h.price, 0);
      const cryptoValue = data.holdings.filter(h => h.type === 'crypto').reduce((sum, h) => sum + h.shares * h.price, 0);
      const totalInvested = stocksValue + cryptoValue;
      const totalValue = totalInvested + data.cash;
      return { stocksValue, cryptoValue, totalInvested, totalValue };
    }
    
    // ==================== CHART ====================
    let valueChart = null;
    
    function initChart() {
      const ctx = document.getElementById('valueChart')?.getContext('2d');
      if (!ctx) return;
      
      if (valueChart) valueChart.destroy();
      
      valueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.weeklyValues.map(v => formatDate(v.date)),
          datasets: [{
            label: 'Portfolio Value',
            data: data.weeklyValues.map(v => v.value),
            borderColor: '#58a6ff',
            backgroundColor: 'rgba(88, 166, 255, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              ticks: { color: '#8b949e', callback: v => '$' + (v/1000) + 'k' },
              grid: { color: '#21262d' }
            },
            x: {
              ticks: { color: '#8b949e' },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // ==================== RENDER ====================
    function render() {
      const { stocksValue, cryptoValue, totalInvested, totalValue } = calculateTotals();
      const investedPercent = totalValue > 0 ? Math.round((totalInvested / totalValue) * 100) : 0;
      
      // Summary bar
      document.getElementById('totalValue').textContent = formatCurrency(totalValue);
      document.getElementById('cashValue').textContent = formatCurrency(data.cash);
      document.getElementById('positionCount').textContent = data.holdings.length;
      document.getElementById('lastUpdated').textContent = formatDate(data.lastUpdated);
      
      // Overview stats
      document.getElementById('statStocks').textContent = formatCurrency(stocksValue);
      document.getElementById('statCrypto').textContent = formatCurrency(cryptoValue);
      document.getElementById('statCash').textContent = formatCurrency(data.cash);
      document.getElementById('statAllocation').textContent = investedPercent + '%';
      
      // Top holdings
      const sorted = [...data.holdings].sort((a, b) => (b.shares * b.price) - (a.shares * a.price)).slice(0, 6);
      document.getElementById('topHoldings').innerHTML = sorted.map(h => `
        <div class="holding-item">
          <div>
            <div class="holding-ticker">${h.symbol}</div>
            <div class="holding-name">${h.name}</div>
          </div>
          <div class="holding-value">
            <div>${formatCurrency(h.shares * h.price)}</div>
            <div class="holding-shares">${h.shares.toFixed(2)} @ $${h.price.toLocaleString()}</div>
          </div>
        </div>
      `).join('');
      
      // Pinky's notes
      const pinkyNotes = data.notes.filter(n => n.author === 'pinky').slice(0, 2);
      document.getElementById('pinkyNotes').innerHTML = pinkyNotes.map(n => `
        <div class="note-card">
          <div class="note-meta"><span>${formatDate(n.date)}</span></div>
          <div class="note-text">${n.text}</div>
        </div>
      `).join('') || '<p style="color:#8b949e;">No recent thoughts. Click "Quick Analysis" for insights.</p>';
      
      // Holdings table
      const stocks = data.holdings.filter(h => h.type === 'stock').sort((a, b) => (b.shares * b.price) - (a.shares * a.price));
      const crypto = data.holdings.filter(h => h.type === 'crypto').sort((a, b) => (b.shares * b.price) - (a.shares * a.price));
      document.getElementById('holdingsTable').innerHTML = [...stocks, ...crypto].map(h => `
        <tr>
          <td class="ticker">${h.symbol}</td>
          <td>${h.name}</td>
          <td>${h.shares.toFixed(4)}</td>
          <td>$${h.price.toLocaleString()}</td>
          <td>${formatCurrency(h.shares * h.price)}</td>
          <td>${h.type}</td>
          <td><button class="btn btn-secondary" onclick="deleteHolding('${h.symbol}')">√ó</button></td>
        </tr>
      `).join('');
      
      // Theses
      document.getElementById('thesesGrid').innerHTML = data.theses.map(t => `
        <div class="thesis-card">
          <div class="thesis-header">
            <span class="thesis-ticker">${t.symbol}</span>
            <span class="thesis-conviction conviction-${t.conviction}">${t.conviction}</span>
          </div>
          <p class="thesis-text">${t.thesis}</p>
          ${t.target ? `<p style="margin-top:10px;color:#8b949e;font-size:0.85rem;">Target: $${t.target}</p>` : ''}
        </div>
      `).join('') || '<p style="color:#8b949e;">No theses yet.</p>';
      
      // Transactions
      document.getElementById('transactionLog').innerHTML = data.transactions.map(t => `
        <div class="watchlist-item">
          <div>
            <div class="watchlist-ticker">${t.action.toUpperCase()} ${t.shares} ${t.symbol}</div>
            <div class="watchlist-note">${formatDate(t.date)} @ $${t.price}${t.notes ? ' ‚Äî ' + t.notes : ''}</div>
          </div>
          <div class="${t.action === 'buy' ? 'positive' : 'negative'}">${formatCurrency(t.shares * t.price)}</div>
        </div>
      `).join('') || '<p style="color:#8b949e;">No transactions logged.</p>';
      
      // Watchlist
      document.getElementById('watchlistItems').innerHTML = data.watchlist.map(w => `
        <div class="watchlist-item">
          <div>
            <div class="watchlist-ticker">${w.symbol}</div>
            <div class="watchlist-note">${w.notes || ''}</div>
          </div>
          ${w.target ? `<div style="color:#8b949e;">Target: $${w.target}</div>` : ''}
        </div>
      `).join('') || '<p style="color:#8b949e;">Watchlist empty.</p>';
      
      // Macro indicators
      document.getElementById('macroGrid').innerHTML = data.macroIndicators.map(m => `
        <div class="macro-card">
          <div class="macro-value">${m.value}</div>
          <div class="macro-name">${m.name}</div>
          <div class="macro-trend trend-${m.trend}">${m.trend === 'up' ? '‚Üë' : m.trend === 'down' ? '‚Üì' : '‚Üí'}</div>
        </div>
      `).join('');
      
      // Notes
      document.getElementById('notesList').innerHTML = data.notes.map(n => `
        <div class="note-card">
          <div class="note-meta">
            <span class="note-author">${n.author === 'pinky' ? 'üß† Pinky' : 'üë§ Chris'}</span>
            <span>${formatDate(n.date)}</span>
          </div>
          <div class="note-text">${n.text}</div>
          ${n.tags?.length ? `<div class="note-tags">${n.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
        </div>
      `).join('') || '<p style="color:#8b949e;">No notes yet.</p>';
      
      // Update chart
      if (valueChart) {
        valueChart.data.labels = data.weeklyValues.map(v => formatDate(v.date));
        valueChart.data.datasets[0].data = data.weeklyValues.map(v => v.value);
        valueChart.update();
      }
    }
    
    // ==================== ASK PINKY ====================
    async function askPinky(type) {
      const btn = document.getElementById(type === 'macro' ? 'askMacroBtn' : 'askQuickBtn');
      const responseDiv = document.getElementById(type === 'macro' ? 'macroResponse' : 'quickResponse');
      const responseText = document.getElementById(type === 'macro' ? 'macroResponseText' : 'quickResponseText');
      
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Analyzing...';
      responseDiv.classList.add('active');
      responseText.textContent = 'Sending request to Pinky via Telegram...';
      
      // Build context
      const { stocksValue, cryptoValue, totalInvested, totalValue } = calculateTotals();
      const topHoldings = [...data.holdings].sort((a,b) => (b.shares*b.price) - (a.shares*a.price)).slice(0,5).map(h => `${h.symbol}: $${(h.shares*h.price).toLocaleString()}`).join(', ');
      
      let message = '';
      if (type === 'macro') {
        message = `üîÆ MACRO ANALYSIS REQUEST\n\nPortfolio: ${formatCurrency(totalValue)} (${formatCurrency(stocksValue)} stocks, ${formatCurrency(cryptoValue)} crypto, ${formatCurrency(data.cash)} cash)\nTop holdings: ${topHoldings}\n\nPlease analyze:\n1. Current macro conditions (VIX, DXY, yields)\n2. BTC liquidation levels and crypto sentiment\n3. Risk assessment for my portfolio\n4. Actionable recommendations`;
      } else {
        message = `üîÆ QUICK ANALYSIS REQUEST\n\nPortfolio: ${formatCurrency(totalValue)}\nTop holdings: ${topHoldings}\nCash: ${formatCurrency(data.cash)}\n\nGive me a quick market pulse and any immediate concerns or opportunities for my positions.`;
      }
      
      // Open Telegram with pre-filled message
      const telegramUrl = `https://t.me/${TELEGRAM_BOT_USERNAME}?text=${encodeURIComponent(message)}`;
      window.open(telegramUrl, '_blank');
      
      responseText.textContent = '‚úÖ Request sent! Check Telegram for Pinky\'s analysis.\n\nNote: Pinky will respond in your Telegram chat. Future versions will show the response here directly.';
      
      btn.disabled = false;
      btn.innerHTML = type === 'macro' ? 'üîÆ Analyze Market & Portfolio' : 'üîÆ Quick Analysis';
    }
    
    // ==================== CRUD OPERATIONS ====================
    async function saveHolding() {
      const symbol = document.getElementById('holdingSymbol').value.toUpperCase();
      const name = document.getElementById('holdingName').value;
      const shares = parseFloat(document.getElementById('holdingShares').value);
      const price = parseFloat(document.getElementById('holdingPrice').value);
      const type = document.getElementById('holdingType').value;
      
      if (!symbol || !shares) return alert('Symbol and shares required');
      
      const existing = data.holdings.findIndex(h => h.symbol === symbol);
      if (existing >= 0) {
        data.holdings[existing] = { symbol, name, shares, price, type };
      } else {
        data.holdings.push({ symbol, name, shares, price, type });
      }
      
      if (supabaseClient) {
        await supabaseClient.from('holdings').upsert({ symbol, name, shares, type }, { onConflict: 'symbol' });
        await supabaseClient.from('prices').upsert({ symbol, price }, { onConflict: 'symbol' });
      }
      
      saveLocal();
      render();
      closeModal('holdingModal');
      clearForm('holding');
    }
    
    async function deleteHolding(symbol) {
      if (!confirm(`Delete ${symbol}?`)) return;
      data.holdings = data.holdings.filter(h => h.symbol !== symbol);
      if (supabaseClient) await supabaseClient.from('holdings').delete().eq('symbol', symbol);
      saveLocal();
      render();
    }
    
    async function saveNote() {
      const author = document.getElementById('noteAuthor').value;
      const text = document.getElementById('noteText').value;
      const tags = document.getElementById('noteTags').value.split(',').map(t => t.trim()).filter(t => t);
      
      if (!text) return alert('Note text required');
      
      const note = { date: new Date().toISOString().split('T')[0], author, text, tags };
      data.notes.unshift(note);
      
      if (supabaseClient) {
        await supabaseClient.from('notes').insert({ author, content: text, tags });
      }
      
      saveLocal();
      render();
      closeModal('noteModal');
      clearForm('note');
    }
    
    async function saveTransaction() {
      const symbol = document.getElementById('txSymbol').value.toUpperCase();
      const action = document.getElementById('txAction').value;
      const shares = parseFloat(document.getElementById('txShares').value);
      const price = parseFloat(document.getElementById('txPrice').value);
      const date = document.getElementById('txDate').value || new Date().toISOString().split('T')[0];
      
      if (!symbol || !shares || !price) return alert('All fields required');
      
      const tx = { symbol, action, shares, price, date };
      data.transactions.unshift(tx);
      
      if (supabaseClient) {
        await supabaseClient.from('transactions').insert({ symbol, action, shares, price, date });
      }
      
      saveLocal();
      render();
      closeModal('transactionModal');
      clearForm('transaction');
    }
    
    async function saveWatchlist() {
      const symbol = document.getElementById('watchSymbol').value.toUpperCase();
      const notes = document.getElementById('watchNotes').value;
      const target = parseFloat(document.getElementById('watchTarget').value) || null;
      
      if (!symbol) return alert('Symbol required');
      
      data.watchlist.push({ symbol, notes, target });
      
      if (supabaseClient) {
        await supabaseClient.from('watchlist').insert({ symbol, notes, target_entry: target });
      }
      
      saveLocal();
      render();
      closeModal('watchlistModal');
      clearForm('watchlist');
    }
    
    async function saveThesis() {
      const symbol = document.getElementById('thesisSymbol').value.toUpperCase();
      const thesis = document.getElementById('thesisText').value;
      const conviction = document.getElementById('thesisConviction').value;
      const target = parseFloat(document.getElementById('thesisTarget').value) || null;
      
      if (!symbol || !thesis) return alert('Symbol and thesis required');
      
      data.theses.push({ symbol, thesis, conviction, target });
      
      if (supabaseClient) {
        await supabaseClient.from('theses').insert({ symbol, thesis, conviction, target_price: target });
      }
      
      saveLocal();
      render();
      closeModal('thesisModal');
      clearForm('thesis');
    }
    
    // ==================== CONFIG ====================
    function showConfigModal() {
      document.getElementById('configUrl').value = supabaseUrl;
      document.getElementById('configKey').value = supabaseKey;
      openModal('configModal');
    }
    
    function saveConfig() {
      supabaseUrl = document.getElementById('configUrl').value.trim();
      supabaseKey = document.getElementById('configKey').value.trim();
      
      localStorage.setItem('supabase_url', supabaseUrl);
      localStorage.setItem('supabase_key', supabaseKey);
      
      initSupabase();
      loadData();
      closeModal('configModal');
    }
    
    // ==================== UI HELPERS ====================
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    
    function clearForm(type) {
      if (type === 'holding') {
        ['holdingSymbol', 'holdingName', 'holdingShares', 'holdingPrice'].forEach(id => document.getElementById(id).value = '');
      } else if (type === 'note') {
        ['noteText', 'noteTags'].forEach(id => document.getElementById(id).value = '');
      } else if (type === 'transaction') {
        ['txSymbol', 'txShares', 'txPrice'].forEach(id => document.getElementById(id).value = '');
      } else if (type === 'watchlist') {
        ['watchSymbol', 'watchNotes', 'watchTarget'].forEach(id => document.getElementById(id).value = '');
      } else if (type === 'thesis') {
        ['thesisSymbol', 'thesisText', 'thesisTarget'].forEach(id => document.getElementById(id).value = '');
      }
    }
    
    // Tab navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });
    
    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(m => {
      m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
    });
    
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    });
    
    // Set default date for transactions
    document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
    
    // ==================== INIT ====================
    // Check session AFTER all code is defined (at the very end)
    if (sessionStorage.getItem(SESSION_KEY) === 'true') {
      console.log('Session found, showing app...');
      showApp();
    } else {
      console.log('No session, showing login screen');
    }
  </script>
</body>
</html>
<!-- deployed Mon Feb  2 22:08:30 CET 2026 -->
<!-- auto-deploy trigger 1770068072 -->
<!-- fix: 1770068774 -->
